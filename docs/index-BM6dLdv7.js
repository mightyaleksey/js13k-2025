let q=2025;function $(n,t){t==null&&(t=n,n=0),q=q*16807%2147483647;const e=(q-1)/2147483646;return Math.floor(e*(t-n+1))+n}function xt(n){for(let t=n.length-1;t>=1;t--){const e=Math.floor($(t));[n[t],n[e]]=[n[e],n[t]]}return n}const dt=[],d=32,bt=[[-1,0],[1,0],[0,-1],[0,1]],ct=.3,nt=.15;function at(){}const Mt=60,yt=1/Mt,Pt=1,T=3,p={buffer:null,context:null},y={touched:!1,touches:{}},D={width:0,height:0},it={getPosition(n){return n==null&&(n=Object.keys(y.touches)[0]),y.touches[n]??null},getTouches(){return Object.keys(y.touches)},wasTouched(){return y.touched}};function St(){const n=p.buffer;p.context.clearRect(0,0,n.width,n.height)}function Et(n,t,e,s,i){p.context.drawImage(n,0,0,n.width,n.height,Math.floor(t),Math.floor(e),Math.floor(s),Math.floor(i))}function Xt(n){return p.context.measureText(n).width}function ht(n,t,e,s){const i=p.context;i.beginPath(),i.moveTo(n,t),i.lineTo(e,s),i.stroke()}function Yt(n,t,e,s,i){const c=p.context;s=s??D.width-t;const o=Xt(n),r=.5*(s-o);c.fillText(n,Math.floor(t+r),Math.floor(e),s)}function N(n,t,e,s,i,c){const o=p.context;o.beginPath(),o.roundRect(Math.floor(t),Math.floor(e),Math.floor(s),Math.floor(i),c??0),n==="fill"?o.fill():o.stroke()}function Tt(n){p.context.rotate(n*Math.PI/180)}function P(n,t){const e=p.context;e.fillStyle=n,e.strokeStyle=n,e.globalAlpha=t??1}function kt(n){const t=p.context;t.font=t.font.replace(/\d+/,String(n))}function It(n,t){p.context.translate(Math.floor(n),Math.floor(t))}async function vt(n,t,e){lt(),n!=null&&await n();const s=e??at,i=t??at,c=gt();p.buffer=c[0],p.context=c[1],document.body?.appendChild(p.buffer),function h(u){const g=rt(),b=g-u;b>=Pt?u=g:b>=yt&&(u=g,i(b),Bt(),lt(),St(),p.context.save(),s(),p.context.restore(),y.touched=!1),window.requestAnimationFrame(()=>{h(u)})}(rt()),document.addEventListener("click",o),document.addEventListener("touchstart",r),document.addEventListener("touchmove",r),document.addEventListener("touchend",a);function o(h){l(h),h.button===0&&(y.touched=!0,y.touches.mouse=[h.pageX/T,h.pageY/T])}function r(h){l(h),y.touched=!0;for(let u=0;u<h.changedTouches.length;u++){const g=h.changedTouches[u];y.touches[String(g.identifier)]=[g.pageX/T,g.pageY/T]}}function a(h){l(h);for(let u=0;u<h.changedTouches.length;u++){const g=h.changedTouches[u];delete y.touches[String(g.identifier)]}}function l(h){h.preventDefault()}}function Ct(n,t,e){const s=[],[i,c]=gt(t,e);for(let o=0;o<n.height;o+=e)for(let r=0;r<n.width;r+=t){c.clearRect(0,0,t,e),c.drawImage(n,-r,-o);const a=new window.Image;a.src=i.toDataURL("image/png"),s.push(a)}return s}function Dt(n){return new Promise((t,e)=>{const s=new window.Image;s.onload=()=>t(s),s.onerror=()=>e(new Error(`Failed to load image: '${n}'`)),s.src=n})}function gt(n,t){const e=document.createElement("canvas");n!=null&&t!=null&&(e.width=n,e.height=t);const s=e.getContext("2d");return s.imageSmoothingEnabled=!1,s.font="8px Consolas, monaco, monospace",s.textBaseline="top",[e,s]}function Bt(){p.buffer.width=window.innerWidth,p.buffer.height=window.innerHeight,p.context.scale(T,T)}function rt(){return .001*Date.now()}function lt(){D.width=Math.ceil(window.innerWidth/T),D.height=Math.ceil(window.innerHeight/T)}function Ot(n,t,e,s){return e*n/s+t}function zt(n,t,e,s){return n=n/s-1,e*(n*n*n+1)+t}function ut(n,t,e,s){return n=n/s*2,n<1?e/2*n*n*n+t:(n=n-2,e/2*(n*n*n+2)+t)}function k(n,t){if(n==null)throw new Error(t??'Unexpected "null" value');return n}const ot=[],W=new Set,C=[];let V=0;function Rt(n){if(C.length!==0){if(V+=n,C.forEach(([t,e,s,i,c,o,r,a])=>{const l=Math.min(V-c,a);t[e]=i(l,o,r,a),l===a&&W.add(s)}),W.size>0){for(let t=C.length-1;t>=0;--t){const e=C[t];W.has(e[2])&&C.splice(t,1)}W.forEach(t=>k(ot[t])()),W.clear()}C.length===0&&(V=0)}}async function Z(n,t,e){const s=new Promise(o=>{ot.push(o)}),i=ot.length-1,c=e??Ot;return n.forEach(([o,r])=>{Object.keys(r).forEach(a=>{const l=o[a],h=r[a];C.push([o,a,i,c,V,l,h-l,t])})}),s}function Ft(n){return new Promise(t=>setTimeout(t,1e3*n))}const At=(...n)=>Gt(pt(...n)),Gt=(...n)=>{const t=tt.createBufferSource(),e=tt.createBuffer(n.length,n[0].length,x);return n.map((s,i)=>e.getChannelData(i).set(s)),t.buffer=e,t.connect(tt.destination),t.start(),t},pt=(n=1,t=.05,e=220,s=0,i=0,c=.1,o=0,r=1,a=0,l=0,h=0,u=0,g=0,b=0,S=0,O=0,_=0,z=1,E=0,R=0)=>{const m=2*Math.PI,j=a*=500*m/x**2,L=(S>0?1:-1)*m/4;let F=e*=(1+2*t*Math.random()-t)*m/x;const I=[];let M=0,A=0,f=0,v=1,_t=0,mt=0,X=0,U,G;for(s=99+x*s,E*=x,i*=x,c*=x,_*=x,l*=500*m/x**3,S*=m/x,h*=m/x,u*=x,g=x*g|0,G=s+E+i+c+_|0;f<G;I[f++]=X)++mt%(100*O|0)||(X=o?o>1?o>2?o>3?Math.sin((M%m)**3):Math.max(Math.min(Math.tan(M),1),-1):1-(2*M/m%2+2)%2:1-4*Math.abs(Math.round(M/m)-M/m):Math.sin(M),X=(g?1-R+R*Math.sin(2*Math.PI*f/g):1)*(X>0?1:-1)*Math.abs(X)**r*n*Nt*(f<s?f/s:f<s+E?1-(f-s)/E*(1-z):f<s+E+i?z:f<G-_?(G-f-_)/c*z:0),X=_?X/2+(_>f?0:(f<G-_?1:(G-f)/_)*I[f-_|0]/2):X),U=(e+=a+=l)*Math.sin(A*S-L),M+=U-U*b*(1-1e9*(Math.sin(f)+1)%2),A+=U-U*b*(1-1e9*(Math.sin(f)**2+1)%2),v&&++v>u&&(e+=h,F+=h,v=0),!g||++_t%g||(e=F,a=j,v=v||1);return I},Nt=.3,x=44100,tt=new(window.AudioContext||window.webkitAudioContext),jt=(n,t,e,s=125)=>{let i,c,o,r,a,l,h,u,g,b,S,O,_,z,E=0,R=[];const m=[],j=[];let L=0,F=0,I=1;const M={},A=x/s*60>>2;for(;I;L++)R=[I=u=O=0],e.map((f,v)=>{for(h=t[f][L]||[0,0,0],I|=!!t[f][L],z=O+(t[f][0].length-2-!u)*A,_=v==e.length-1,c=2,r=O;c<h.length+_;u=++c){for(a=h[c],g=c==h.length+_-1&&_||b!=(h[0]||0)|a|0,o=0;o<A&&u;o++>A-99&&g?S+=(S<1)/99:0)l=(1-S)*R[E++]/2||0,m[r]=(m[r]||0)-l*F+l,j[r]=(j[r++]||0)+l*F+l;a&&(S=a%1,F=h[1]||0,(a|=0)&&(R=M[[b=h[E=0]||0,a]]=M[[b,a]]||(i=[...n[b]],i[2]*=2**((a-12)/12),a>0?pt(...i):[])))}O=z});return[m,j]},K={};async function Lt(){K.error=[.6,,30,.01,.04,.06,2,3.8,3,,,,,1.8,,,,.92,.03,,-2186],K.select=[.8,0,630,.01,.01,.01,1,3.4,.1,,,,,,,,.2,.8,.01,,564],K.match=[,,18,.01,.01,.03,,2.7,43,,,,,.1,,,,.65,.01,.17,-1423],await Ut([[[1.8,0,72,,,.2,,4,-2,6,50,.15,,6],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[1.2,0,23,,,.2,3,4,,,3,.9,.05],[1.5,0,740,,,.15,2,.2,-.1,-.15,9,.02,,.1,.12,,.06]],[[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,,,,,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,25,,,25,,25,25,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,]],[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,8,8,8,5,13],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,,,,,,,,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13]],[[3,-1,13,13,13,8,13,,13,15,17,17,15,13,20,20,18,17,18,,,,17,,15,,,,17,,18,,22,22,22,,18,,,,25,25,25,,22,,,18,20,22,20,,,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,11,,23,,11,11,23,11,,11,23,11,11,11,23,,10,,22,,10,10,22,10,,10,22,10,10,6,8,10,20,25,20,20,25,20,,20,25,20,20,20,25,,20,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,15,13,,17,15,13,,15,,,,10,13,15,10,13,15,10,13,15,10,13,15,12,,,,,,8,15,,,,,17,15,13,8,13,,,,,,10,8,,20,20,20,20,20,20,20],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,15,,27,,15,15,27,15,,15,27,15,15,15,27,32,20,,32,,20,20,32,20,,20,32,20,20,20,32,,13,,25,,13,13,25,20,,20,32,20,20,20,32,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[2,-1,13,,25,25,13,,25,25,13,,25,25,13,,25,25,15,,27,27,15,,27,27,15,,27,27,15,,27,27,20,,32,32,20,,32,32,20,,32,32,20,,32,32,13,,25,25,13,,25,25,20,,32,32,20,,32,34],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,25,,,25,,,,25,25,25,25,25],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13,,13,13,13,13,13,13,13]]],[0,1,2,2,3,3,2,2,4,4,5,6,6,7,2,2,3]])}function J(n){const t=k(K[n]);At(...t)}function Ut(n){return new Promise(t=>{setTimeout(()=>t(jt(...n)),20)})}class B{enter(t){}exit(){}render(){}update(t){}}const Q=.2*d,Y=.8*d,w=1.5*d,et=2*d,Wt=[Q,Y,w],Ht=[[Y+1,Q+4,Y+4,Q+3],[Y+3,Y-4,Y+7,Y-4],[w+1,w-6,w+4,w-7],[w,w-4,w+6,w-4],[w+8,w-3,w+16,w-3],[Q,w+14,Y,w+14]];class Jt extends B{render(){const{width:t,height:e}=D;P("#e8ad90"),N("fill",0,0,t,e);for(let s=0;s<t;s+=et)for(let i=0;i<e;i+=et)this._drawPattern(s,i)}_drawPattern(t,e){P("#8f5f4f"),Wt.forEach(s=>{ht(t,e+s,et,e+s)}),P("#f4bba0"),Ht.forEach(s=>ht(t+s[0],e+s[1],t+s[2],e+s[3]))}}const st="No piece found";class Vt extends B{constructor(){super(),this.pageX=0,this.pageY=0,this.width=0,this.height=0}}class wt extends Vt{constructor(){super(),this.angle=0,this.clientX=0,this.clientY=0}render(){this.angle!==0&&(It(-this.clientX,-this.clientY),Tt(this.angle))}update(t){const e=this.angle;this.clientX=e!==0?-(this.pageX+.5*this.width):0,this.clientY=e!==0?-(this.pageY+.5*this.height):0}}class Zt extends wt{constructor(t,e,s){super(),this.id=s,this.offsetX=0,this.offsetY=0,this.x=t,this.y=e,this.width=d,this.height=d,this._updateOffset()}render(){const t=this.clientX+this.pageX+this.offsetX,e=this.clientY+this.pageY+this.offsetY;P("#EACD95"),N("fill",t+1,e+1,this.width-2,this.height-2,2),P("#FEE7BC"),N("line",t+1,e+1,this.width-2,this.height-2,2),Et(dt[this.id],t,e,this.width,this.height)}toJSON(){return{x:this.x,y:this.y,id:this.id}}_updateOffset(){this.offsetX=this.x*this.width,this.offsetY=this.y*this.height}}class Kt extends B{constructor(){super(),this.target=null}render(){const t=this.target;t!=null&&(P("#E7040F"),N("line",t.clientX+t.pageX+t.x*t.width,t.clientY+t.pageY+t.y*t.height,t.width,t.height,2))}}class Qt extends wt{constructor(t,e,s,i){super(),this.expectedIDs=s??3,this.expectedMoves=i??2,this.columns=t??6,this.rows=e??5,this.table=[],this.selection=new Kt,this._updateDimentions(),this._updatePagePosition()}render(){super.render();const t=this.clientX+this.pageX,e=this.clientY+this.pageY,s=this.columns*d,i=this.rows*d;P("#BE8353"),N("fill",t,e,s,i,2),this.table.forEach(c=>c.forEach(o=>{o!=null&&(o.clientX=this.clientX,o.clientY=this.clientY,o.render())})),this.selection.render()}update(t){super.update(t),this.selection.update(t)}toJSON(){return this.table.map(t=>t.map(e=>e?.id??null))}_genBoard(){const t=this.table;t.length=0;for(let e=0;e<this.rows;++e){t.push([]);for(let s=0;s<this.columns;++s)t[e].push(this._genPiece(s,e))}for(;this._getMatches().length>0||!this._hasMoves();)this._genBoard()}_genPiece(t,e){const s=new Zt(t,e,$(this.expectedIDs));return s.pageX=this.pageX,s.pageY=this.pageY,s}_getPiece(t,e,s){const i=s===0?t:e,c=s===0?e:t;return i<0||i>=this.columns||c<0||c>=this.rows?null:this.table[c][i]}_hasPiece(t,e){return this._getPiece(t,e,0)!=null}_removePieces(t){t.forEach(e=>{this.table[e.y][e.x]=null})}_clearSelection(){this.selection.target=null}_getSelection(){return this.selection.target}_updateSelection(t,e){this.selection.target=this._getPiece(t,e,0)}_getFallingPieces(){const t=this.table,e=Array(this.rows+1).fill(null);for(let s=0;s<this.columns;++s){let i=0;for(let c=this.rows-1;c>=0;--c){const o=this._getPiece(s,c,0);o==null?i++:i>0&&(o.y+=i,t[c+i][s]=o,t[c][s]=null,e[i]==null&&(e[i]=[]),e[i].push(o))}for(let c=0;c<i;++c){const o=this._genPiece(s,c);o.offsetY-=i*d,t[o.y][o.x]=o,e[i]==null&&(e[i]=[]),e[i].push(o)}}return e}_getMatches(){const t=[];for(let e=0;e<2;++e){const s=e===0?this.rows:this.columns,i=e===0?this.columns:this.rows;for(let c=0;c<s;++c){let o=1,r=this._getPiece(0,c,e)?.id;for(let a=1;a<i;++a){const l=this._getPiece(a,c,e);l?.id===r?o++:(o=1,r=l?.id),o===3&&(t.push(k(this._getPiece(a-2,c,e),st)),t.push(k(this._getPiece(a-1,c,e),st))),o>=3&&t.push(k(l,st))}}}return t}_hasMoves(){let t=0;for(let e=0;e<this.rows;++e){let s=this._getPiece(0,e,0)?.id;for(let i=1;i<this.columns;++i){const c=this._getPiece(i,e,0);if(c?.id===s){if((this._hasSiblingPieces(i-2,e,c.id)||this._hasSiblingPieces(i+1,e,c.id))&&t++,t===this.expectedMoves)return!0}else s=c?.id}}return!1}_hasSiblingPieces(t,e,s){let i=0;return bt.forEach(c=>{this._getPiece(c[0],c[1],0)?.id===s&&i++}),i>1}_toVirtualCoords(t){if(t==null)return null;const e=Math.min(Math.floor(Math.max(t[0]-this.pageX,0)/d),this.columns),s=Math.min(Math.floor(Math.max(t[1]-this.pageY,0)/d),this.rows);return[e,s]}_transpose(){const t=(this.angle+360)%360;if(t===0)return;const e=t===180?this.rows:this.columns,s=t===180?this.columns:this.rows,i=Array(e).fill(0).map(()=>Array(s).fill(null));this.table.forEach((c,o)=>c.forEach((r,a)=>{const l=this._transposeX(a,o,t),h=this._transposeY(a,o,t);i[h][l]=r,r!=null&&(r.x=l,r.y=h)})),this.table.length=0,this.table=i,this.columns=s,this.rows=e,this._updateDimentions(),this._updatePagePosition(),i.forEach(c=>c.forEach(o=>{o!=null&&(o.pageX=this.pageX,o.pageY=this.pageY,o._updateOffset())})),this.angle=0}_transposeX(t,e,s){switch(s){case 90:return this.rows-e-1;case 180:return this.columns-t-1;case 270:return e;default:return t}}_transposeY(t,e,s){switch(s){case 90:return t;case 180:return this.rows-e-1;case 270:return this.columns-t-1;default:return e}}_updateDimentions(){this.width=this.columns*d,this.height=this.rows*d}_updatePagePosition(){this.pageX=.5*(D.width-this.width),this.pageY=.5*(D.height-this.height)}}const ft=xt([-270,-180,-90,90,180,270]);class $t extends B{enter(){this.cursor=[-1,-1],this.interactive=!0,this.moves=0,this.stepsBeforeRotation=$(4,5),this.bg=new Jt,this.board=new Qt,this.board._genBoard()}render(){this.bg.render(),this.board.render()}update(t){if(this.board.update(t),this.interactive&&it.wasTouched()){const e=this.board._toVirtualCoords(it.getPosition());e!=null&&(this.cursor[0]=e[0],this.cursor[1]=e[1],this._handleInput())}}_canMove(t){const e=k(this.board._getSelection()),s=this.board.table;s[t.y][t.x]=e,s[e.y][e.x]=t;const i=this.board._getMatches();return s[t.y][t.x]=t,s[e.y][e.x]=e,i.length>0}async _handleInput(){const t=this.board,e=t._getSelection();if(e!=null){const s=e.x-this.cursor[0],i=e.y-this.cursor[1];if(s===0&&i===0){t._clearSelection();return}const c=Math.abs(s)+Math.abs(i)===1,o=t._getPiece(this.cursor[0],this.cursor[1],0);if(o!=null)if(c&&this._canMove(o)){if(J("select"),this.interactive=!1,this.moves++,await this._swapPieces(o),await this._updateBoard(),this.moves%this.stepsBeforeRotation===0){this.stepsBeforeRotation=$(4,5);const r=k(ft.shift());ft.push(r),await this._rotateBoard(r)}this.interactive=!0}else J("error"),t.selection.target=o}else t._updateSelection(this.cursor[0],this.cursor[1]),t._hasPiece(this.cursor[0],this.cursor[1])&&J("select")}async _rotateBoard(t){const e=2*Math.floor(Math.abs(t/90));await Z([[this.board,{angle:t}]],e*ct,ut),this.board._transpose()}async _swapPieces(t){const e=k(this.board._getSelection()),s=this.board.table;s[t.y][t.x]=e,s[e.y][e.x]=t;const i=t.x,c=t.y;t.x=e.x,t.y=e.y,e.x=i,e.y=c,this.board._updateSelection(-1,-1),await Z([[e,{offsetX:e.x*d,offsetY:e.y*d}],[t,{offsetX:t.x*d,offsetY:t.y*d}]],ct,ut)}async _updateBoard(){let t=this.board._getMatches();for(;t.length>0;)this.board._removePieces(t),J("match"),await Ft(.5*nt),await this.board._getFallingPieces().reduce((s,i,c)=>i==null?s:Z(i.map(o=>[o,{offsetY:o.y*d}]),c*nt*2),null),t=this.board._getMatches()}}class qt extends B{constructor(){super(),this.opacity=.5}render(){const{width:t,height:e}=D;P("#000",this.opacity),N("fill",0,0,t,e),P("#edf2f4"),kt(42),Yt("Cats Puzzle",0,.5*e,null)}update(){it.wasTouched()&&this._startGame()}async _startGame(){await Z([[this,{opacity:0}]],nt,zt),H.pop()}}class te extends B{constructor(t){super(),this.current=new B,this.states=t}change(t,e){return this.current.exit(),this.current=this.states[t](),this.current.enter(e),this}render(){this.current.render()}update(t){this.current.update(t)}}class ee{constructor(){this.stack=[]}pop(){this.stack[this.stack.length-1].exit(),this.stack.pop()}push(t){t.enter(),this.stack.push(t)}render(){this.stack.forEach(t=>t.render())}update(t){this.stack[this.stack.length-1].update(t)}}const H=new ee;function se(){H.push(new te({play:()=>new $t}).change("play")),H.push(new qt)}async function ne(){dt.push(...Ct(await Dt("./pieces.webp"),2*d,2*d)),se(),await Lt()}function ie(n){Rt(n),H.update(n)}function oe(){H.render()}vt(ne,ie,oe);
