let U=2025;function at(s,t){t==null&&(t=s,s=0),U=U*16807%2147483647;const e=(U-1)/2147483646;return Math.floor(e*(t-s+1))+s}function Q(){}const rt=60,lt=1/rt,ut=1,P=3,m={buffer:null,context:null},M={touched:!1,touches:{}},L={width:0,height:0},$={getPosition(s){return s==null&&(s=Object.keys(M.touches)[0]),M.touches[s]??null},getTouches(){return Object.keys(M.touches)},wasTouched(){return M.touched}};function ft(){const s=m.buffer;m.context.clearRect(0,0,s.width,s.height)}function W(s,t,e,n,i,o){const c=m.context;c.beginPath(),c.roundRect(Math.floor(t),Math.floor(e),Math.floor(n),Math.floor(i),o),s==="fill"?c.fill():c.stroke()}function dt(s){m.context.rotate(s*Math.PI/180)}function Z(s,t){const e=m.context;e.fillStyle=s,e.strokeStyle=s}function gt(s,t){m.context.translate(Math.floor(s),Math.floor(t))}async function pt(s,t,e){et(),s!=null&&await s();const n=e??Q,i=t??Q,o=_t();m.buffer=o[0],m.context=o[1],document.body?.appendChild(m.buffer),function h(l){const f=tt(),x=f-l;x>=ut?l=f:x>=lt&&(l=f,i(x),wt(),et(),ft(),m.context.save(),n(),m.context.restore(),M.touched=!1),window.requestAnimationFrame(()=>{h(l)})}(tt()),document.addEventListener("click",c),document.addEventListener("touchstart",d),document.addEventListener("touchmove",d),document.addEventListener("touchend",a);function c(h){r(h),h.button===0&&(M.touched=!0,M.touches.mouse=[h.pageX/P,h.pageY/P])}function d(h){r(h),M.touched=!0;for(let l=0;l<h.changedTouches.length;l++){const f=h.changedTouches[l];M.touches[String(f.identifier)]=[f.pageX/P,f.pageY/P]}}function a(h){r(h);for(let l=0;l<h.changedTouches.length;l++){const f=h.changedTouches[l];delete M.touches[String(f.identifier)]}}function r(h){h.preventDefault()}}function _t(){const s=document.createElement("canvas"),t=s.getContext("2d");return t.imageSmoothingEnabled=!1,t.font="8px Consolas, monaco, monospace",t.textBaseline="top",[s,t]}function wt(){m.buffer.width=window.innerWidth,m.buffer.height=window.innerHeight,m.context.scale(P,P)}function tt(){return .001*Date.now()}function et(){L.width=Math.ceil(window.innerWidth/P),L.height=Math.ceil(window.innerHeight/P)}function mt(s,t,e,n){return e*s/n+t}function xt(s,t,e,n){return s=s/n*2,s<1?e/2*s*s*s+t:(s=s-2,e/2*(s*s*s+2)+t)}function T(s,t){if(s==null)throw new Error(t??'Unexpected "null" value');return s}const q=[],A=new Set,k=[];let j=0;function bt(s){if(k.length!==0){if(j+=s,k.forEach(([t,e,n,i,o,c,d,a])=>{const r=Math.min(j-o,a);t[e]=i(r,c,d,a),r===a&&A.add(n)}),A.size>0){for(let t=k.length-1;t>=0;--t){const e=k[t];A.has(e[2])&&k.splice(t,1)}A.forEach(t=>T(q[t])()),A.clear()}k.length===0&&(j=0)}}async function st(s,t,e){const n=new Promise(c=>{q.push(c)}),i=q.length-1,o=e??mt;return s.forEach(([c,d])=>{Object.keys(d).forEach(a=>{const r=c[a],h=d[a];k.push([c,a,i,o,j,r,h-r,t])})}),n}const Mt=(...s)=>yt(it(...s)),yt=(...s)=>{const t=H.createBufferSource(),e=H.createBuffer(s.length,s[0].length,_);return s.map((n,i)=>e.getChannelData(i).set(n)),t.buffer=e,t.connect(H.destination),t.start(),t},it=(s=1,t=.05,e=220,n=0,i=0,o=.1,c=0,d=1,a=0,r=0,h=0,l=0,f=0,x=0,y=0,I=0,g=0,C=1,S=0,D=0)=>{const p=2*Math.PI,B=a*=500*p/_**2,F=(y>0?1:-1)*p/4;let O=e*=(1+2*t*Math.random()-t)*p/_;const Y=[];let b=0,v=0,u=0,X=1,ct=0,ht=0,E=0,R,z;for(n=99+_*n,S*=_,i*=_,o*=_,g*=_,r*=500*p/_**3,y*=p/_,h*=p/_,l*=_,f=_*f|0,z=n+S+i+o+g|0;u<z;Y[u++]=E)++ht%(100*I|0)||(E=c?c>1?c>2?c>3?Math.sin((b%p)**3):Math.max(Math.min(Math.tan(b),1),-1):1-(2*b/p%2+2)%2:1-4*Math.abs(Math.round(b/p)-b/p):Math.sin(b),E=(f?1-D+D*Math.sin(2*Math.PI*u/f):1)*(E>0?1:-1)*Math.abs(E)**d*s*St*(u<n?u/n:u<n+S?1-(u-n)/S*(1-C):u<n+S+i?C:u<z-g?(z-u-g)/o*C:0),E=g?E/2+(g>u?0:(u<z-g?1:(z-u)/g)*Y[u-g|0]/2):E),R=(e+=a+=r)*Math.sin(v*y-F),b+=R-R*x*(1-1e9*(Math.sin(u)+1)%2),v+=R-R*x*(1-1e9*(Math.sin(u)**2+1)%2),X&&++X>l&&(e+=h,O+=h,X=0),!f||++ct%f||(e=O,a=B,X=X||1);return Y},St=.3,_=44100,H=new(window.AudioContext||window.webkitAudioContext),Et=(s,t,e,n=125)=>{let i,o,c,d,a,r,h,l,f,x,y,I,g,C,S=0,D=[];const p=[],B=[];let F=0,O=0,Y=1;const b={},v=_/n*60>>2;for(;Y;F++)D=[Y=l=I=0],e.map((u,X)=>{for(h=t[u][F]||[0,0,0],Y|=!!t[u][F],C=I+(t[u][0].length-2-!l)*v,g=X==e.length-1,o=2,d=I;o<h.length+g;l=++o){for(a=h[o],f=o==h.length+g-1&&g||x!=(h[0]||0)|a|0,c=0;c<v&&l;c++>v-99&&f?y+=(y<1)/99:0)r=(1-y)*D[S++]/2||0,p[d]=(p[d]||0)-r*O+r,B[d]=(B[d++]||0)+r*O+r;a&&(y=a%1,O=h[1]||0,(a|=0)&&(D=b[[x=h[S=0]||0,a]]=b[[x,a]]||(i=[...s[x]],i[2]*=2**((a-12)/12),a>0?it(...i):[])))}I=C});return[p,B]},G={};async function Pt(){G.fall=[2.1,,454,,.02,.06,2,3.8,-8,,,,,1.1,,.2,.12,.85,.02],G.match=[,,18,.01,.01,.03,,2.7,43,,,,,.1,,,,.65,.01,.17,-1423],G.selection=[.9,,426,.01,.03,.07,1,3.1,17,-14,,,,,,,,.68,.06,,240],await Yt([[[1.8,0,72,,,.2,,4,-2,6,50,.15,,6],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[1.2,0,23,,,.2,3,4,,,3,.9,.05],[1.5,0,740,,,.15,2,.2,-.1,-.15,9,.02,,.1,.12,,.06]],[[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,,,,,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,25,,,25,,25,25,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,]],[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,8,8,8,5,13],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,,,,,,,,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13]],[[3,-1,13,13,13,8,13,,13,15,17,17,15,13,20,20,18,17,18,,,,17,,15,,,,17,,18,,22,22,22,,18,,,,25,25,25,,22,,,18,20,22,20,,,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,11,,23,,11,11,23,11,,11,23,11,11,11,23,,10,,22,,10,10,22,10,,10,22,10,10,6,8,10,20,25,20,20,25,20,,20,25,20,20,20,25,,20,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,15,13,,17,15,13,,15,,,,10,13,15,10,13,15,10,13,15,10,13,15,12,,,,,,8,15,,,,,17,15,13,8,13,,,,,,10,8,,20,20,20,20,20,20,20],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,15,,27,,15,15,27,15,,15,27,15,15,15,27,32,20,,32,,20,20,32,20,,20,32,20,20,20,32,,13,,25,,13,13,25,20,,20,32,20,20,20,32,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[2,-1,13,,25,25,13,,25,25,13,,25,25,13,,25,25,15,,27,27,15,,27,27,15,,27,27,15,,27,27,20,,32,32,20,,32,32,20,,32,32,20,,32,32,13,,25,25,13,,25,25,20,,32,32,20,,32,34],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,25,,,25,,,,25,25,25,25,25],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13,,13,13,13,13,13,13,13]]],[0,1,2,2,3,3,2,2,4,4,5,6,6,7,2,2,3]])}function J(s){const t=T(G[s]);Mt(...t)}function Yt(s){return new Promise(t=>{setTimeout(()=>t(Et(...s)),20)})}const w=32,Xt=[[-1,0],[1,0],[0,-1],[0,1]],kt=.3,nt=.15;function Tt(s){return new Promise(t=>setTimeout(t,1e3*s))}class N{enter(t){}exit(){}render(){}update(t){}}const V="No piece found";class ot extends N{constructor(){super(),this.pageX=0,this.pageY=0,this.width=0,this.height=0}}class It extends ot{constructor(){super(),this.angle=0,this.clientX=0,this.clientY=0}update(t){const e=this.angle;this.clientX=e>0?-(this.pageX+.5*this.width):0,this.clientY=e>0?-(this.pageY+.5*this.height):0}}const Ct=["#FF6300","#5E2CA5","#357EDD","#137752","#00449E","#E7040F","#001B44"];class Dt extends ot{constructor(t,e,n){super(),this.id=n,this.clientX=0,this.clientY=0,this.offsetX=0,this.offsetY=0,this.x=t,this.y=e,this.width=w,this.height=w,this._updateOffset()}render(){Z(Ct[this.id]),W("fill",this.clientX+this.pageX+this.offsetX+1,this.clientY+this.pageY+this.offsetY+1,this.width-2,this.height-2,2)}toJSON(){return{x:this.x,y:this.y,id:this.id}}_updateOffset(){this.offsetX=this.x*this.width,this.offsetY=this.y*this.height}}class Ot extends N{constructor(){super(),this.target=null}render(){const t=this.target;t!=null&&(Z("#E7040F"),W("line",t.pageX+t.x*t.width,t.pageY+t.y*t.height,t.width,t.height,2))}}class vt extends It{constructor(t,e,n,i){super(),this.expectedIDs=n??3,this.expectedMoves=i??2,this.columns=t??5,this.rows=e??5,this.table=[],this.selection=new Ot,this.width=this.columns*w,this.height=this.rows*w}render(){const t=this.clientX+this.pageX,e=this.clientY+this.pageY,n=this.columns*w,i=this.rows*w;this.angle>0&&(gt(-this.clientX,-this.clientY),dt(this.angle)),Z("#19A974"),W("fill",t,e,n,i,2),this.table.forEach(o=>o.forEach(c=>{c!=null&&(c.clientX=this.clientX,c.clientY=this.clientY,c.render())})),this.selection.render()}update(t){this.selection.update(t)}toJSON(){return this.table.map(t=>t.map(e=>e?.id??null))}_genBoard(){const t=this.table;t.length=0;for(let e=0;e<this.rows;++e){t.push([]);for(let n=0;n<this.columns;++n)t[e].push(this._genPiece(n,e))}for(;this._getMatches().length>0||!this._hasMoves();)this._genBoard()}_genPiece(t,e){const n=new Dt(t,e,at(this.expectedIDs));return n.pageX=this.pageX,n.pageY=this.pageY,n}_getPiece(t,e,n){const i=n===0?t:e,o=n===0?e:t;return i<0||i>=this.columns||o<0||o>=this.rows?null:this.table[o][i]}_hasPiece(t,e){return this._getPiece(t,e,0)!=null}_removePieces(t){t.forEach(e=>{this.table[e.y][e.x]=null})}_clearSelection(){this.selection.target=null}_getSelection(){return this.selection.target}_updateSelection(t,e){this.selection.target=this._getPiece(t,e,0)}_getFallingPieces(){const t=this.table,e=Array(this.rows+1).fill(null);for(let n=0;n<this.columns;++n){let i=0;for(let o=this.rows-1;o>=0;--o){const c=this._getPiece(n,o,0);c==null?i++:i>0&&(c.y+=i,t[o+i][n]=c,t[o][n]=null,e[i]==null&&(e[i]=[]),e[i].push(c))}for(let o=0;o<i;++o){const c=this._genPiece(n,o);c.offsetY-=i*w,t[c.y][c.x]=c,e[i]==null&&(e[i]=[]),e[i].push(c)}}return e}_getMatches(){const t=[];for(let e=0;e<2;++e){const n=e===0?this.rows:this.columns,i=e===0?this.columns:this.rows;for(let o=0;o<n;++o){let c=1,d=this._getPiece(0,o,e)?.id;for(let a=1;a<i;++a){const r=this._getPiece(a,o,e);r?.id===d?c++:(c=1,d=r?.id),c===3&&(t.push(T(this._getPiece(a-2,o,e),V)),t.push(T(this._getPiece(a-1,o,e),V))),c>=3&&t.push(T(r,V))}}}return t}_hasMoves(){let t=0;for(let e=0;e<this.rows;++e){let n=this._getPiece(0,e,0)?.id;for(let i=1;i<this.columns;++i){const o=this._getPiece(i,e,0);if(o?.id===n){if((this._hasSiblingPieces(i-2,e,o.id)||this._hasSiblingPieces(i+1,e,o.id))&&t++,t===this.expectedMoves)return!0}else n=o?.id}}return!1}_hasSiblingPieces(t,e,n){let i=0;return Xt.forEach(o=>{this._getPiece(o[0],o[1],0)?.id===n&&i++}),i>1}_toVirtualCoords(t){if(t==null)return null;const e=Math.min(Math.floor(Math.max(t[0]-this.pageX,0)/w),this.columns),n=Math.min(Math.floor(Math.max(t[1]-this.pageY,0)/w),this.rows);return[e,n]}}class zt extends N{enter(){this.cursor=[-1,-1],this.interactive=!0;const t=this.board=new vt;t.pageX=.5*(L.width-t.width),t.pageY=.5*(L.height-t.height),t._genBoard()}render(){this.board.render()}update(t){if(this.board.update(t),this.interactive&&$.wasTouched()){const e=this.board._toVirtualCoords($.getPosition());e!=null&&(this.cursor[0]=e[0],this.cursor[1]=e[1],this._handleInput())}}_canMove(t){const e=T(this.board._getSelection()),n=this.board.table;n[t.y][t.x]=e,n[e.y][e.x]=t;const i=this.board._getMatches();return n[t.y][t.x]=t,n[e.y][e.x]=e,i.length>0}async _handleInput(){const t=this.board,e=t._getSelection();if(e!=null){const n=e.x-this.cursor[0],i=e.y-this.cursor[1];if(n===0&&i===0){t._clearSelection();return}const o=Math.abs(n)+Math.abs(i)===1,c=t._getPiece(this.cursor[0],this.cursor[1],0);c!=null&&(o&&this._canMove(c)?(this.interactive=!1,await this._swapPieces(c),await this._updateBoard(),this.interactive=!0):(J("selection"),t.selection.target=c))}else t._updateSelection(this.cursor[0],this.cursor[1]),t._hasPiece(this.cursor[0],this.cursor[1])&&J("selection")}async _swapPieces(t){const e=T(this.board._getSelection()),n=this.board.table;n[t.y][t.x]=e,n[e.y][e.x]=t;const i=t.x,o=t.y;t.x=e.x,t.y=e.y,e.x=i,e.y=o,this.board._updateSelection(-1,-1),await st([[e,{offsetX:e.x*w,offsetY:e.y*w}],[t,{offsetX:t.x*w,offsetY:t.y*w}]],kt,xt)}async _updateBoard(){let t=this.board._getMatches();for(;t.length>0;)this.board._removePieces(t),J("match"),await Tt(.5*nt),await this.board._getFallingPieces().reduce((n,i,o)=>i==null?n:st(i.map(c=>[c,{offsetY:c.y*w}]),o*nt*2),null),t=this.board._getMatches()}}class Bt extends N{constructor(t){super(),this.current=new N,this.states=t}change(t,e){return this.current.exit(),this.current=this.states[t](),this.current.enter(e),this}render(){this.current.render()}update(t){this.current.update(t)}}class Ft{constructor(){this.stack=[]}pop(){this.stack[this.stack.length-1].exit(),this.stack.pop()}push(t){t.enter(),this.stack.push(t)}render(){this.stack.forEach(t=>t.render())}update(t){this.stack[this.stack.length-1].update(t)}}const K=new Ft;async function Rt(){await Pt(),K.push(new Bt({play:()=>new zt}).change("play"))}function At(s){bt(s),K.update(s)}function Nt(){K.render()}pt(Rt,At,Nt);
