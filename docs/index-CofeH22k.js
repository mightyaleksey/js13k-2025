let G=2025;function it(i,t){t==null&&(t=i,i=0),G=G*16807%2147483647;const e=(G-1)/2147483646;return Math.floor(e*(t-i+1))+i}function R(){}const nt=60,ot=1/nt,ht=1,S=3,_={buffer:null,context:null},y={touched:!1,touches:{}},A={width:0,height:0},W={getPosition(i){return i==null&&(i=Object.keys(y.touches)[0]),y.touches[i]??null},getTouches(){return Object.keys(y.touches)},wasTouched(){return y.touched}};function ct(){const i=_.buffer;_.context.clearRect(0,0,i.width,i.height)}function H(i,t,e,s,o,n){const h=_.context;h.beginPath(),h.roundRect(Math.floor(t),Math.floor(e),Math.floor(s),Math.floor(o),n),i==="fill"?h.fill():h.stroke()}function J(i,t){const e=_.context;e.fillStyle=i,e.strokeStyle=i}async function rt(i,t,e){K(),i!=null&&await i();const s=e??R,o=t??R,n=at();_.buffer=n[0],_.context=n[1],document.body?.appendChild(_.buffer),function c(a){const f=Z(),x=f-a;x>=ht?a=f:x>=ot&&(a=f,o(x),lt(),K(),ct(),_.context.save(),s(),_.context.restore(),y.touched=!1),window.requestAnimationFrame(()=>{c(a)})}(Z()),document.addEventListener("click",h),document.addEventListener("touchstart",d),document.addEventListener("touchmove",d),document.addEventListener("touchend",r);function h(c){p(c),c.button===0&&(y.touched=!0,y.touches.mouse=[c.pageX/S,c.pageY/S])}function d(c){p(c),y.touched=!0;for(let a=0;a<c.changedTouches.length;a++){const f=c.changedTouches[a];y.touches[String(f.identifier)]=[f.pageX/S,f.pageY/S]}}function r(c){p(c);for(let a=0;a<c.changedTouches.length;a++){const f=c.changedTouches[a];delete y.touches[String(f.identifier)]}}function p(c){c.preventDefault()}}function at(){const i=document.createElement("canvas"),t=i.getContext("2d");return t.imageSmoothingEnabled=!1,t.font="8px Consolas, monaco, monospace",t.textBaseline="top",[i,t]}function lt(){_.buffer.width=window.innerWidth,_.buffer.height=window.innerHeight,_.context.scale(S,S)}function Z(){return .001*Date.now()}function K(){A.width=Math.ceil(window.innerWidth/S),A.height=Math.ceil(window.innerHeight/S)}function O(i,t){if(i==null)throw new Error(t??'Unexpected "null" value');return i}const ut=(...i)=>ft(tt(...i)),ft=(...i)=>{const t=L.createBufferSource(),e=L.createBuffer(i.length,i[0].length,w);return i.map((s,o)=>e.getChannelData(o).set(s)),t.buffer=e,t.connect(L.destination),t.start(),t},tt=(i=1,t=.05,e=220,s=0,o=0,n=.1,h=0,d=1,r=0,p=0,c=0,a=0,f=0,x=0,b=0,Y=0,g=0,D=1,P=0,X=0)=>{const m=2*Math.PI,B=r*=500*m/w**2,F=(b>0?1:-1)*m/4;let k=e*=(1+2*t*Math.random()-t)*m/w;const T=[];let M=0,z=0,l=0,C=1,et=0,st=0,E=0,N,I;for(s=99+w*s,P*=w,o*=w,n*=w,g*=w,p*=500*m/w**3,b*=m/w,c*=m/w,a*=w,f=w*f|0,I=s+P+o+n+g|0;l<I;T[l++]=E)++st%(100*Y|0)||(E=h?h>1?h>2?h>3?Math.sin((M%m)**3):Math.max(Math.min(Math.tan(M),1),-1):1-(2*M/m%2+2)%2:1-4*Math.abs(Math.round(M/m)-M/m):Math.sin(M),E=(f?1-X+X*Math.sin(2*Math.PI*l/f):1)*(E>0?1:-1)*Math.abs(E)**d*i*dt*(l<s?l/s:l<s+P?1-(l-s)/P*(1-D):l<s+P+o?D:l<I-g?(I-l-g)/n*D:0),E=g?E/2+(g>l?0:(l<I-g?1:(I-l)/g)*T[l-g|0]/2):E),N=(e+=r+=p)*Math.sin(z*b-F),M+=N-N*x*(1-1e9*(Math.sin(l)+1)%2),z+=N-N*x*(1-1e9*(Math.sin(l)**2+1)%2),C&&++C>a&&(e+=c,k+=c,C=0),!f||++et%f||(e=k,r=B,C=C||1);return T},dt=.3,w=44100,L=new(window.AudioContext||window.webkitAudioContext),pt=(i,t,e,s=125)=>{let o,n,h,d,r,p,c,a,f,x,b,Y,g,D,P=0,X=[];const m=[],B=[];let F=0,k=0,T=1;const M={},z=w/s*60>>2;for(;T;F++)X=[T=a=Y=0],e.map((l,C)=>{for(c=t[l][F]||[0,0,0],T|=!!t[l][F],D=Y+(t[l][0].length-2-!a)*z,g=C==e.length-1,n=2,d=Y;n<c.length+g;a=++n){for(r=c[n],f=n==c.length+g-1&&g||x!=(c[0]||0)|r|0,h=0;h<z&&a;h++>z-99&&f?b+=(b<1)/99:0)p=(1-b)*X[P++]/2||0,m[d]=(m[d]||0)-p*k+p,B[d]=(B[d++]||0)+p*k+p;r&&(b=r%1,k=c[1]||0,(r|=0)&&(X=M[[x=c[P=0]||0,r]]=M[[x,r]]||(o=[...i[x]],o[2]*=2**((r-12)/12),r>0?tt(...o):[])))}Y=D});return[m,B]},j={};async function gt(){j.fall=[2.1,,454,,.02,.06,2,3.8,-8,,,,,1.1,,.2,.12,.85,.02],j.match=[,,18,.01,.01,.03,,2.7,43,,,,,.1,,,,.65,.01,.17,-1423],await mt([[[1.8,0,72,,,.2,,4,-2,6,50,.15,,6],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[1.2,0,23,,,.2,3,4,,,3,.9,.05],[1.5,0,740,,,.15,2,.2,-.1,-.15,9,.02,,.1,.12,,.06]],[[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,,,,,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,25,,,25,,25,25,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,]],[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,8,8,8,5,13],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,,,,,,,,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13]],[[3,-1,13,13,13,8,13,,13,15,17,17,15,13,20,20,18,17,18,,,,17,,15,,,,17,,18,,22,22,22,,18,,,,25,25,25,,22,,,18,20,22,20,,,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,11,,23,,11,11,23,11,,11,23,11,11,11,23,,10,,22,,10,10,22,10,,10,22,10,10,6,8,10,20,25,20,20,25,20,,20,25,20,20,20,25,,20,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,15,13,,17,15,13,,15,,,,10,13,15,10,13,15,10,13,15,10,13,15,12,,,,,,8,15,,,,,17,15,13,8,13,,,,,,10,8,,20,20,20,20,20,20,20],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,15,,27,,15,15,27,15,,15,27,15,15,15,27,32,20,,32,,20,20,32,20,,20,32,20,20,20,32,,13,,25,,13,13,25,20,,20,32,20,20,20,32,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[2,-1,13,,25,25,13,,25,25,13,,25,25,13,,25,25,15,,27,27,15,,27,27,15,,27,27,15,,27,27,20,,32,32,20,,32,32,20,,32,32,20,,32,32,13,,25,25,13,,25,25,20,,32,32,20,,32,34],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,25,,,25,,,,25,25,25,25,25],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13,,13,13,13,13,13,13,13]]],[0,1,2,2,3,3,2,2,4,4,5,6,6,7,2,2,3]])}function V(i){const t=O(j[i]);ut(...t)}function mt(i){return new Promise(t=>{setTimeout(()=>t(pt(...i)),20)})}const u=32,wt=.3,Q=.15;function _t(i){return new Promise(t=>setTimeout(t,1e3*i))}function $(i,t,e,s){return e*i/s+t}function xt(i,t,e,s){return i=i/s*2,i<1?e/2*i*i*i+t:(i=i-2,e/2*(i*i*i+2)+t)}class v{enter(t){}exit(){}render(){}update(t){}}const U="No piece found",Mt="No prop found";class yt extends v{constructor(){super(),this.duration=0,this.time=0,this.easing=$,this.props=[],this.done=R,this.promise=null}update(t){this.duration!==0&&(this.time=Math.min(this.time+t,this.duration),this.props.forEach(e=>{e[0][e[1]]=this.easing(Math.min(this.time,e[4]),e[2],e[3],e[4])}),this.time===this.duration&&(this.duration=0,this.props.length=0,this.done(),this.done=R,this.promise=null))}async tween(t,e){return this.duration=Math.max(e.wait,this.duration),this.easing=e.easing??$,this.time=0,t.forEach(([s,o])=>{Object.keys(o).forEach(n=>{if(typeof s[n]!="number")throw new Error(Mt);const h=o[n]-s[n];this.props.push([s,n,s[n],h,this.duration])})}),this._genPromise()}_genPromise(){return this.promise!=null?this.promise:this.promise=new Promise(t=>{this.done=t})}}const bt=["#FF6300","#5E2CA5","#357EDD","#137752","#00449E","#E7040F","#001B44"];class Pt extends v{constructor(t,e,s){super(),this.id=s,this.x=t,this.y=e,this.clientX=this.x*u,this.clientY=this.y*u,this.offsetX=0,this.offsetY=0}render(){J(bt[this.id]),H("fill",this.offsetX+this.clientX+1,this.offsetY+this.clientY+1,u-2,u-2,2)}toJSON(){return{x:this.x,y:this.y,id:this.id}}}const Et=[[-1,0],[1,0],[0,-1],[0,1]];class St extends v{constructor(t,e,s){super(),this.width=t??5,this.height=e??5,this.pieces=[],this.offsetX=0,this.offsetY=0,this.maxIDs=3,this.minMoves=s??2,this._genBoard()}render(){const{width:t,height:e}=A,s=this.width*u,o=this.height*u,n=this.offsetX=.5*(t-s),h=this.offsetY=.5*(e-o);J("#19A974"),H("fill",n,h,s,o,2),this.pieces.forEach(d=>d.forEach(r=>{r!=null&&(r.offsetX=n,r.offsetY=h,r.render())}))}mapCoords(t){if(t==null)return null;const{width:e,height:s}=A,o=.5*(e-this.width*u),n=.5*(s-this.height*u),h=Math.min(Math.floor(Math.max(t[0]-o,0)/u),this.width),d=Math.min(Math.floor(Math.max(t[1]-n,0)/u),this.height);return[h,d]}toJSON(){return this.pieces.map(t=>t.map(e=>e?.id??null))}_genBoard(){const t=this.pieces=[];for(let e=0;e<this.height;++e){t.push([]);for(let s=0;s<this.width;++s)t[e].push(this._genPiece(s,e))}for(;this._getMatches().length>0||!this._hasMoves(this.minMoves);)this._genBoard()}_getFallingPieces(){const t=this.pieces,e=Array(this.height+1).fill(null);for(let s=0;s<this.width;++s){let o=0;for(let n=this.height-1;n>=0;--n){const h=this._getPiece(s,n,0);h==null?o++:o>0&&(h.y+=o,t[n+o][s]=h,t[n][s]=null,e[o]==null&&(e[o]=[]),e[o].push(h))}for(let n=0;n<o;++n){const h=this._genPiece(s,n);h.clientY-=o*u,t[h.y][h.x]=h,e[o]==null&&(e[o]=[]),e[o].push(h)}}return e}_genPiece(t,e){return new Pt(t,e,it(this.maxIDs))}_getMatches(){const t=[];for(let e=0;e<2;++e){const s=e===0?this.height:this.width,o=e===0?this.width:this.height;for(let n=0;n<s;++n){let h=1,d=this._getPiece(0,n,e)?.id;for(let r=1;r<o;++r){const p=this._getPiece(r,n,e);p?.id===d?h++:(h=1,d=p?.id),h===3&&(t.push(O(this._getPiece(r-2,n,e),U)),t.push(O(this._getPiece(r-1,n,e),U))),h>=3&&t.push(O(p,U))}}}return t}_getPiece(t,e,s){const o=s===0?t:e,n=s===0?e:t;return o<0||o>=this.width||n<0||n>=this.height?null:this.pieces[n][o]}_hasMoves(t){let e=0;for(let s=0;s<this.height;++s){let o=this._getPiece(0,s,0)?.id;for(let n=1;n<this.width;++n){const h=this._getPiece(n,s,0);if(h?.id===o){if((this._hasSiblingPieces(n-2,s,h.id)||this._hasSiblingPieces(n+1,s,h.id))&&e++,e===t)return!0}else o=h?.id}}return!1}_hasSiblingPieces(t,e,s){let o=0;return Et.forEach(n=>{this._getPiece(n[0],n[1],0)?.id===s&&o++}),o>1}_removePieces(t){t.forEach(e=>{this.pieces[e.y][e.x]=null})}}class Tt extends v{enter(){this.animation=new yt,this.cursor=[-1,-1],this.interactive=!0,this.selectedPiece=null,this.board=new St}render(){this.board.render();const t=this.selectedPiece;t!=null&&(J("#E7040F"),H("line",this.board.offsetX+t.x*u,this.board.offsetY+t.y*u,u,u,2))}update(t){if(this.animation.update(t),this.board.update(t),W.wasTouched()){const e=this.board.mapCoords(W.getPosition());e!=null&&(this.cursor[0]=e[0],this.cursor[1]=e[1],this._handleInput())}}_canMove(t){const e=O(this.selectedPiece),s=this.board.pieces;s[t.y][t.x]=e,s[e.y][e.x]=t;const o=this.board._getMatches();return s[t.y][t.x]=t,s[e.y][e.x]=e,o.length>0}async _handleInput(){if(this.selectedPiece!=null){const t=this.selectedPiece.x-this.cursor[0],e=this.selectedPiece.y-this.cursor[1];if(t===0&&e===0){this.selectedPiece=null;return}const s=Math.abs(t)+Math.abs(e)===1,o=this.board._getPiece(this.cursor[0],this.cursor[1],0);o!=null&&s&&this._canMove(o)&&(await this._swapPieces(o),await this._updateBoard())}else{const t=this.board._getPiece(this.cursor[0],this.cursor[1],0);this.selectedPiece=t}}async _swapPieces(t){const e=O(this.selectedPiece),s=this.board.pieces;s[t.y][t.x]=e,s[e.y][e.x]=t;const o=t.x,n=t.y;t.x=e.x,t.y=e.y,e.x=o,e.y=n,this.selectedPiece=null,await this.animation.tween([[e,{clientX:e.x*u,clientY:e.y*u}],[t,{clientX:t.x*u,clientY:t.y*u}]],{easing:xt,wait:wt})}async _updateBoard(){let t=this.board._getMatches();for(;t.length>0;)this.board._removePieces(t),V("match"),await _t(.5*Q),await this.board._getFallingPieces().reduce((s,o,n)=>o==null?s:this.animation.tween(o.map(h=>[h,{clientY:h.y*u}]),{wait:n*Q*2}),null),V("fall"),t=this.board._getMatches()}}class Ct extends v{constructor(t){super(),this.current=new v,this.states=t}change(t,e){return this.current.exit(),this.current=this.states[t](),this.current.enter(e),this}render(){this.current.render()}update(t){this.current.update(t)}}class Yt{constructor(){this.stack=[]}pop(){this.stack[this.stack.length-1].exit(),this.stack.pop()}push(t){t.enter(),this.stack.push(t)}render(){this.stack.forEach(t=>t.render())}update(t){this.stack[this.stack.length-1].update(t)}}const q=new Yt;q.push(new Ct({play:()=>new Tt}).change("play"));async function Dt(){await gt()}function Xt(i){q.update(i)}function kt(){q.render()}rt(Dt,Xt,kt);
